(()=>{"use strict";let e=null,t=!1,n=null,l=null;async function a(){return l||(t?Promise.resolve():n?Promise.reject(n):(l=(async()=>{try{if("object"!=typeof WebAssembly||"function"!=typeof WebAssembly.instantiate||"function"!=typeof WebAssembly.instantiateStreaming)throw new Error("WebAssembly is not supported in this browser");await new Promise((e,t)=>{if(void 0!==window.Go)return void e(void 0);const n=document.createElement("script");n.src=void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmExecUrl?window.gllInfoSettings.wasmExecUrl:"/wp-content/plugins/gll-info/assets/wasm/wasm_exec.js",n.onload=()=>e(void 0),n.onerror=()=>t(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)});const n=new window.Go,l=await fetch(void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmUrl?window.gllInfoSettings.wasmUrl:"/wp-content/plugins/gll-info/assets/wasm/gll.wasm");if(!l.ok)throw new Error(`Failed to fetch WASM: ${l.status} ${l.statusText}`);const a=await WebAssembly.instantiateStreaming(l,n.importObject);if(e=a.instance,n.run(e),"function"!=typeof window.parseGLL)throw new Error("WASM module did not export parseGLL function");t=!0}catch(e){throw n=e,e}})(),l))}const r=a;function o(e){const t=(e+180)%360-180;return 180===Math.abs(t)?"±180°":Math.abs(t)<1e-6?"0°":`${t}°`}function s(e,t,n,l){var a;const r=e?.Responses||e?.responses||[],o=e?.Definition?.BalloonData||e?.definition?.balloon_data,s=o?.AngularResolution||o?.angular_resolution;if(!r.length||!s||!t)return null;let i=(n%360+360)%360,u=l;const c=null!==(a=t.symmetry)&&void 0!==a?a:0,d=2===c||3===c;if(4===c?i=0:3===c?i>=270?i=360-i:i>=180?i-=180:i>=90&&(i=180-i):1===c?i>=180&&(i=360-i):2===c&&(i-=90,i<0?i=-i:i>=180&&(i=360-i)),u<0||u>180)return null;if(t.frontHalfOnly&&u>90)return null;if(u>t.measuredParallelDeg){if(!d)return null;{const e=180-u;if(!(e<=t.measuredParallelDeg))return null;u=e}}const f=Math.round(i/t.meridianStep),m=Math.round(u/t.parallelStep);if(f<0||f>=t.meridianCount||m<0||m>=t.parallelCount)return null;const p=function(e,t,n,l,a){return 0===t||t===l-1&&!a||0===e?t:l+(e-1)*(l-(a?1:2))+(t-1)}(f,m,t.meridianCount,t.parallelCount,t.frontHalfOnly);return null!==p&&p>=0&&p<r.length?r[p]:null}const i={id:"polarCompass",afterDraw(e){const t=e.scales?.r;if(!t)return;const{xCenter:n,yCenter:l,drawingArea:a}=t,r=e.ctx;r.save(),r.font="bold 12px sans-serif",r.fillStyle="#334155",r.textBaseline="middle",r.textAlign="left",r.fillText("Front",n+a+40,l),r.textAlign="right",r.fillText("Back",n-a-40,l),r.textAlign="center",r.textBaseline="bottom",r.fillStyle="#2563eb",r.fillText("Right",n-18,l-a-28),r.fillStyle="#dc2626",r.fillText("Top",n+18,l-a-28),r.textBaseline="top",r.fillStyle="#2563eb",r.fillText("Left",n-22,l+a+28),r.fillStyle="#dc2626",r.fillText("Bottom",n+22,l+a+28),r.restore()}};function u(e,t){const n=e.querySelector(".gll-polar-plot-loading");n&&(n.style.display="none");const l=e.querySelector(".gll-polar-plot-chart");l&&(l.innerHTML=`\n\t\t\t<div class="gll-error" style="padding: 20px; color: #d63638; border: 1px solid #d63638; border-radius: 4px; background: #fff8f8;">\n\t\t\t\t<strong>Error:</strong> ${t}\n\t\t\t</div>\n\t\t`,l.style.display="block")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.querySelectorAll(".gll-polar-plot-block");if(0!==e.length)if("undefined"!=typeof Chart){try{await r()}catch(t){return console.error("Failed to initialize WASM:",t),void e.forEach(e=>{u(e,"Failed to initialize WASM parser")})}e.forEach(e=>{!async function(e){const n=e.dataset.fileUrl,l=e.dataset.fileName||"GLL File",r=parseInt(e.dataset.sourceIndex,10)||0,c=parseInt(e.dataset.frequencyIndex,10)||0,d="false"!==e.dataset.showHorizontal,f="false"!==e.dataset.showVertical,m="true"===e.dataset.normalized,p=parseInt(e.dataset.chartHeight,10)||400;if(n)try{const g=await fetch(n);if(!g.ok)throw new Error(`Failed to fetch file: ${g.statusText}`);const h=await g.arrayBuffer(),y=new Uint8Array(h),b=await async function(e){if(!e.name.toLowerCase().endsWith(".gll"))throw new Error("Invalid file type. Please select a .gll file.");return async function(e){t||await a();const n=e instanceof Uint8Array?e:new Uint8Array(e),l=window.parseGLL(n),r=JSON.parse(l);if(!r.success)throw new Error(r.error||"Failed to parse GLL file");return r.data}(await e.arrayBuffer())}(y),w=e.querySelector(".gll-polar-plot-loading");w&&(w.style.display="none"),function(e,t,n){const l=e.querySelector(".gll-polar-plot-chart");if(!l)return;const a=(t?.Database?.SourceDefinitions||[]).filter(e=>(e.Responses||[]).length>0)[n.sourceIndex];if(!a)return void u(e,"Source not found");const r=a.Responses?.[0]?.Frequencies||[];if(0===r.length)return void u(e,"No frequency data available");const c=Math.min(n.frequencyIndex,r.length-1),d=function(e,t){const n=function(e){var t,n,l;const a=e?.Definition?.BalloonData||e?.definition?.balloon_data,r=a?.AngularResolution||a?.angular_resolution,o=r?.MeridianStep||r?.meridian_step,s=r?.ParallelStep||r?.parallel_step;if(!r||!o||!s)return null;const i=null!==(t=null!==(n=r?.Symmetry)&&void 0!==n?n:r?.symmetry)&&void 0!==t?t:0,u=!!(null!==(l=r?.FrontHalfOnly)&&void 0!==l?l:r?.front_half_only),c=Math.max(1,Math.round(360/o)),d=Math.max(1,Math.round(180/s)+1),f=e?.Responses?.length||e?.responses?.length||0;let m;switch(i){case 4:m=1;break;case 3:m=Math.max(1,Math.round(90/o)+1);break;case 1:case 2:m=Math.max(1,Math.round(180/o)+1);break;default:m=c}const p=u?Math.max(1,Math.round(90/s)+1):d;return{meridianCount:m,parallelCount:p,symmetry:i,frontHalfOnly:u,measuredMeridianDeg:(m-1)*o,measuredParallelDeg:(p-1)*s,meridianStep:o,parallelStep:s,responseCount:f,fullMeridianCount:c,fullParallelCount:d,symmetryName:["None","Vertical","Horizontal","Quarter","Axial"][i]||"Unknown"}}(e);if(!n)return null;const l=function(){const e=[0];for(let t=-10;t>=-180;t-=10)e.push(t);for(let t=170;t>0;t-=10)e.push(t);return e}(),a=l.map(o),r=[],i=[],u=n.measuredParallelDeg,c=2===n.symmetry||3===n.symmetry,d=e?.Definition||e?.definition,f=d?.OnAxisSpectrum||d?.on_axis_spectrum,m=function(e,t){if(!e)return null;const n=Number(e.bands_per_octave),l=Number(e.start_freq),a=Number(e.point_count);if(!n||!l)return null;const r=Number.isFinite(t)&&t>0?t:a;return!r||r<=0?null:Array.from({length:r},(e,t)=>l*Math.pow(2,t/n))}(f?.definition||f?.Definition,f?.level?.length||f?.Level?.length),p=f?.level||f?.Level||[],g=(e?.Responses||e?.responses||[])[0],h=g?.Frequencies||g?.frequencies||[],y=f&&Array.isArray(p)&&p.length>0&&Array.isArray(m)&&g&&h.length===m.length&&p.length==p.length&&function(e,t){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++){const l=e[n],a=t[n];if(!Number.isFinite(l)||!Number.isFinite(a))return!1;if(Math.abs(l-a)/Math.max(1,Math.abs(a))>.001)return!1}return!0}(h,m);return l.forEach(l=>{const a=Math.abs(l),o=s(e,n,l>=0?90:270,a),u=(o?.Level||o?.level||[])[t];r.push(y&&Number.isFinite(u)?u+p[t]:null!=u?u:null);const c=Math.abs(l),d=s(e,n,l>=0?0:180,c),f=(d?.Level||d?.level||[])[t];i.push(y&&Number.isFinite(f)?f+p[t]:null!=f?f:null)}),{labels:a,horizontal:{levels:r,meridianDeg:90},vertical:{levels:i,meridianDeg:0,maxParallel:u,canMirrorParallel:c},meta:{usesOnAxis:!!y,symmetry:n.symmetry,symmetryName:n.symmetryName,frontHalfOnly:n.frontHalfOnly,measuredMeridianDeg:n.measuredMeridianDeg,measuredParallelDeg:n.measuredParallelDeg,stepDeg:10}}}(a,c);if(!d)return void u(e,"No directivity data available for this source");const f=r[c];let m=d.horizontal.levels,p=d.vertical.levels;if(n.normalized){const e=Math.max(...m.filter(e=>null!==e&&!isNaN(e))),t=Math.max(...p.filter(e=>null!==e&&!isNaN(e)));m=m.map(t=>null===t||isNaN(t)?t:t-e),p=p.map(e=>null===e||isNaN(e)?e:e-t)}const g=function(e){let t=null,n=null;for(const l of e)null===l||isNaN(l)||((null===t||l<t)&&(t=l),(null===n||l>n)&&(n=l));return{min:t,max:n}}([...n.showHorizontal?m:[],...n.showVertical?p:[]]),h=null!==g.max?g.max+3:void 0,y=null!==g.max?g.max-40:void 0,b=(v=f)&&0!==v?v>=1e3?(v/1e3).toFixed(2)+" kHz":v.toFixed(1)+" Hz":"-",w=n.normalized?" (normalized)":"",x=[];var v;n.showHorizontal&&x.push({label:`Horizontal @ ${b}${w}`,data:m,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.12)",pointRadius:0,borderWidth:2,fill:!0,tension:.2}),n.showVertical&&x.push({label:`Vertical @ ${b}${w}`,data:p,borderColor:"#dc2626",backgroundColor:"rgba(220, 38, 38, 0.12)",pointRadius:0,borderWidth:2,fill:!0,tension:.2});const M=[];M.push(`<span class="gll-meta-badge"><strong>Frequency:</strong> ${b}</span>`),M.push(`<span class="gll-meta-badge"><strong>Symmetry:</strong> ${d.meta.symmetryName}</span>`),M.push(`<span class="gll-meta-badge"><strong>Resolution:</strong> ${d.meta.stepDeg}°</span>`),n.normalized&&M.push('<span class="gll-meta-badge gll-meta-badge-highlight"><strong>Normalized</strong></span>'),d.meta.usesOnAxis&&M.push('<span class="gll-meta-badge">Uses on-axis</span>'),d.meta.frontHalfOnly&&M.push('<span class="gll-meta-badge">Front-half only</span>');const A=a.Definition?.Label||a.Label||"";A&&M.push(`<span class="gll-meta-badge"><strong>Source:</strong> ${A}</span>`);const S=`<div class="gll-polar-plot-metadata">${M.join("")}</div>`,N=document.createElement("canvas");l.innerHTML=S;const L=document.createElement("div");L.className="gll-chart-container",L.style.minHeight=n.chartHeight+"px",L.appendChild(N),l.appendChild(L),l.style.display="block";const C=N.getContext("2d");new Chart(C,{type:"radar",plugins:[i],data:{labels:d.labels,datasets:x},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:700},layout:{padding:{top:30,bottom:30,left:30,right:30}},plugins:{legend:{position:"top"},tooltip:{callbacks:{title:e=>{const t=e?.[0]?.label;return t?`Angle ${t}`:""},label:e=>null==e?.raw?`${e.dataset?.label||"Level"}: -`:`${e.dataset?.label||"Level"}: ${e.raw.toFixed(1)} dB`}}},scales:{r:{suggestedMin:y,suggestedMax:h,startAngle:90,ticks:{backdropColor:"transparent",color:"#64748b"},grid:{color:"rgba(148, 163, 184, 0.25)"},angleLines:{color:"rgba(148, 163, 184, 0.25)"},pointLabels:{color:"#64748b",font:{size:10}}}}}})}(e,b,{fileName:l,sourceIndex:r,frequencyIndex:c,showHorizontal:d,showVertical:f,normalized:m,chartHeight:p})}catch(t){console.error("Error loading GLL file:",t),u(e,t.message)}else u(e,"No file URL specified")}(e)})}else console.error("Chart.js is not loaded")})})();