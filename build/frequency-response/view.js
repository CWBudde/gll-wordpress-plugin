(()=>{"use strict";let e=null,t=!1,n=null,a=null;async function s(){return a||(t?Promise.resolve():n?Promise.reject(n):(a=(async()=>{try{if("object"!=typeof WebAssembly||"function"!=typeof WebAssembly.instantiate||"function"!=typeof WebAssembly.instantiateStreaming)throw new Error("WebAssembly is not supported in this browser");await new Promise((e,t)=>{if(void 0!==window.Go)return void e(void 0);const n=document.createElement("script");n.src=void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmExecUrl?window.gllInfoSettings.wasmExecUrl:"/wp-content/plugins/gll-info/assets/wasm/wasm_exec.js",n.onload=()=>e(void 0),n.onerror=()=>t(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)});const n=new window.Go,a=await fetch(void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmUrl?window.gllInfoSettings.wasmUrl:"/wp-content/plugins/gll-info/assets/wasm/gll.wasm");if(!a.ok)throw new Error(`Failed to fetch WASM: ${a.status} ${a.statusText}`);const s=await WebAssembly.instantiateStreaming(a,n.importObject);if(e=s.instance,n.run(e),"function"!=typeof window.parseGLL)throw new Error("WASM module did not export parseGLL function");t=!0}catch(e){throw n=e,e}})(),a))}const r=s;function o(e,t){if(!Array.isArray(e)||!Array.isArray(t))return null;if(0===e.length||0===t.length)return null;if(e.length!==t.length)return null;const n=e.map((e,n)=>({x:e,y:t[n]})),a=Math.min(...e),s=Math.max(...e);return Number.isFinite(a)&&Number.isFinite(s)?{points:n,minFrequency:a,maxFrequency:s}:null}function i(e,t){return null==e||Number.isNaN(e)?"-":Number(e).toFixed(t)}function l(e){return e&&0!==e?e>=1e3?(e/1e3).toFixed(2)+" kHz":e.toFixed(1)+" Hz":"-"}function c(e,t){const n=e.querySelector(".gll-frequency-response-loading");n&&(n.style.display="none");const a=e.querySelector(".gll-frequency-response-chart");a&&(a.innerHTML=`\n\t\t\t<div class="gll-error" style="padding: 20px; color: #d63638; border: 1px solid #d63638; border-radius: 4px; background: #fff8f8;">\n\t\t\t\t<strong>Error:</strong> ${t}\n\t\t\t</div>\n\t\t`,a.style.display="block")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.querySelectorAll(".gll-frequency-response-block");if(0!==e.length)if("undefined"!=typeof Chart){try{await r()}catch(t){return console.error("Failed to initialize WASM:",t),void e.forEach(e=>{c(e,"Failed to initialize WASM parser")})}e.forEach(e=>{!async function(e){const n=e.dataset.fileUrl,a=e.dataset.fileName||"GLL File",r=parseInt(e.dataset.sourceIndex,10)||0,u=parseInt(e.dataset.responseIndex,10)||0,d=e.dataset.phaseMode||"unwrapped",p="true"===e.dataset.normalized,f=parseFloat(e.dataset.azimuth)||0,h=parseFloat(e.dataset.elevation)||0,g="false"!==e.dataset.showPhase,m="false"!==e.dataset.showMagnitude,y=parseInt(e.dataset.chartHeight,10)||400;if(n)try{const w=await fetch(n);if(!w.ok)throw new Error(`Failed to fetch file: ${w.statusText}`);const b=await w.arrayBuffer(),x=new Uint8Array(b),v=await async function(e){if(!e.name.toLowerCase().endsWith(".gll"))throw new Error("Invalid file type. Please select a .gll file.");return async function(e){t||await s();const n=e instanceof Uint8Array?e:new Uint8Array(e),a=window.parseGLL(n),r=JSON.parse(a);if(!r.success)throw new Error(r.error||"Failed to parse GLL file");return r.data}(await e.arrayBuffer())}(x),M=e.querySelector(".gll-frequency-response-loading");M&&(M.style.display="none"),function(e,t,n){const a=e.querySelector(".gll-frequency-response-chart");if(!a)return;const s=t?.Database?.SourceDefinitions?.[n.sourceIndex];if(!s)return void c(e,"Source not found");const r=function(e,t,n,a,s){if(!e||!e.Responses||0===e.Responses.length)return null;const r=e.Responses[t];if(!r)return null;const o=r.Frequencies||[];if(0===o.length)return null;const i=r.TransferFunctions||[];if(0===i.length)return null;const l=i[0],c=l.Magnitude||[],u=l.Phase||[];if(0===c.length)return null;let d=c;if(s&&c.length>0){const e=c[0];d=c.map(t=>t-e)}return{frequencies:o,magnitudes:d,phases:u.length===c.length?u:[]}}(s,n.responseIndex,0,0,n.normalized);if(!r)return void c(e,"No frequency response data available for this source");const{frequencies:u,magnitudes:d,phases:p}=r,f=o(u,d);if(!f)return void c(e,"Invalid frequency response data");let h=null;if(n.showPhase&&p.length>0){const e=function(e){if(!Array.isArray(e)||0===e.length)return[];const t=[e[0]];let n=0;for(let a=1;a<e.length;a++){const s=e[a]-e[a-1];s>Math.PI?n-=2*Math.PI:s<-Math.PI&&(n+=2*Math.PI),t.push(e[a]+n)}return t}(p);h=function(e,t,n,a){switch(e){case"wrapped":return{values:n.map(e=>function(e){if(null==e)return null;const t=2*Math.PI;return((e+Math.PI)%t+t)%t-Math.PI}(e)),label:"Phase (rad)",axisTitle:"Phase (rad)",format:e=>i(e,4)};case"group-delay":{const e=function(e,t){if(!Array.isArray(e)||0===e.length)return[];const n=Math.min(e.length,t.length),a=new Array(n),s=-1/(2*Math.PI);for(let r=0;r<n;r++){let o,i;if(0===r?(o=t[r+1]-t[r],i=e[r+1]-e[r]):r===n-1?(o=t[r]-t[r-1],i=e[r]-e[r-1]):(o=t[r+1]-t[r-1],i=e[r+1]-e[r-1]),!i||0===i||Number.isNaN(i)||Number.isNaN(o)){a[r]=null;continue}const l=s*(o/i);a[r]=1e3*l}return a}(t,a);return{values:e,label:"Group Delay (ms)",axisTitle:"Group Delay (ms)",format:e=>i(e,3)}}default:return{values:a,label:"Phase (rad)",axisTitle:"Phase (rad)",format:e=>i(e,4)}}}(n.phaseMode,u,p,e)}const g=function({source:e,frequencyData:t,options:n,phaseSeries:a}){const s=l(t.minFrequency),r=l(t.maxFrequency),o=[];if(o.push(`<span class="gll-meta-badge"><strong>Range:</strong> ${s} - ${r}</span>`),0!==n.azimuth||0!==n.elevation?o.push(`<span class="gll-meta-badge"><strong>Position:</strong> Az ${n.azimuth}째 / El ${n.elevation}째</span>`):o.push('<span class="gll-meta-badge"><strong>Position:</strong> On-axis (0째 / 0째)</span>'),a){const e="group-delay"===n.phaseMode?"Group Delay":"wrapped"===n.phaseMode?"Wrapped Phase":"Unwrapped Phase";o.push(`<span class="gll-meta-badge"><strong>Phase:</strong> ${e}</span>`)}return n.normalized&&o.push('<span class="gll-meta-badge gll-meta-badge-highlight"><strong>Normalized</strong></span>'),e.Label&&o.push(`<span class="gll-meta-badge"><strong>Source:</strong> ${e.Label}</span>`),`<div class="gll-frequency-response-metadata">${o.join("")}</div>`}({source:s,frequencyData:f,options:n,phaseSeries:h}),m=document.createElement("canvas");a.innerHTML=g;const y=document.createElement("div");y.className="gll-chart-container",y.appendChild(m),a.appendChild(y),a.style.display="block";const w=m.getContext("2d"),b=[];if(n.showMagnitude&&b.push({label:"Level (dB)",data:f.points,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3,pointRadius:0,yAxisID:"y"}),h){const e=o(u,h.values);e&&b.push({label:h.label,data:e.points,borderColor:"#dc2626",backgroundColor:"transparent",tension:.3,pointRadius:0,yAxisID:"y1"})}const x={x:(v=f.minFrequency,M=f.maxFrequency,I="Frequency",{type:"logarithmic",title:{display:!0,text:I},ticks:{autoSkip:!1,callback:e=>{const t=Number(e);return function(e){if(!e||e<=0)return!1;const t=Math.log10(e);return Number.isInteger(t)}(t)?(n=t)&&0!==n?n>=1e3?(n/1e3).toFixed(1)+"k":n.toFixed(0):"-":"";var n}},min:v,max:M,afterBuildTicks:e=>{e.ticks=function(e,t){if(!e||!t||e<=0||t<=0)return[];const n=[],a=Math.max(1,Math.floor(Math.log10(e))),s=Math.ceil(Math.log10(t));for(let r=a;r<=s;r++){const a=Math.pow(10,r);for(let s=1;s<=9;s++){const r=s*a;r<e||r>t||n.push({value:r})}}return n}(e.min,e.max)}})};var v,M,I;n.showMagnitude&&(x.y={type:"linear",display:!0,position:"left",title:{display:!0,text:"Level (dB)"}}),h&&(x.y1={type:"linear",display:!0,position:"right",title:{display:!0,text:h.axisTitle},grid:{drawOnChartArea:!1}}),new Chart(w,{type:"line",data:{datasets:b},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:x,plugins:{legend:{position:"top"},title:{display:!0,text:n.fileName+(s.Label?` - ${s.Label}`:"")},tooltip:{callbacks:{title:e=>{const t=e?.[0]?.parsed?.x;return t?l(t):""}}}}}})}(e,v,{fileName:a,sourceIndex:r,responseIndex:u,phaseMode:d,normalized:p,azimuth:f,elevation:h,showPhase:g,showMagnitude:m,chartHeight:y})}catch(t){console.error("Error loading GLL file:",t),c(e,t.message)}else c(e,"No file URL specified")}(e)})}else console.error("Chart.js is not loaded")})})();