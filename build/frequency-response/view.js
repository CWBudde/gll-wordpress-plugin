(()=>{"use strict";var e={d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{hT:()=>i});let n=null,a=!1,r=null,s=null;async function o(){return s||(a?Promise.resolve():r?Promise.reject(r):(s=(async()=>{try{if("object"!=typeof WebAssembly||"function"!=typeof WebAssembly.instantiate||"function"!=typeof WebAssembly.instantiateStreaming)throw new Error("WebAssembly is not supported in this browser");await new Promise((e,t)=>{if(void 0!==window.Go)return void e();const n=document.createElement("script");n.src=void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmExecUrl?window.gllInfoSettings.wasmExecUrl:"/wp-content/plugins/gll-info/assets/wasm/wasm_exec.js",n.onload=e,n.onerror=()=>t(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)});const e=new window.Go,t=await fetch(void 0!==window.gllInfoSettings&&window.gllInfoSettings.wasmUrl?window.gllInfoSettings.wasmUrl:"/wp-content/plugins/gll-info/assets/wasm/gll.wasm");if(!t.ok)throw new Error(`Failed to fetch WASM: ${t.status} ${t.statusText}`);const r=await WebAssembly.instantiateStreaming(t,e.importObject);if(n=r.instance,e.run(n),"function"!=typeof window.parseGLL)throw new Error("WASM module did not export parseGLL function");a=!0}catch(e){throw r=e,e}})(),s))}async function i(e){if(!e.name.toLowerCase().endsWith(".gll"))throw new Error("Invalid file type. Please select a .gll file.");return async function(e){a||await o();const t=e instanceof Uint8Array?e:new Uint8Array(e),n=window.parseGLL(t),r=JSON.parse(n);if(!r.success)throw new Error(r.error||"Failed to parse GLL file");return r.data}(await e.arrayBuffer())}function l(e,t){if(!Array.isArray(e)||!Array.isArray(t))return null;if(0===e.length||0===t.length)return null;if(e.length!==t.length)return null;const n=e.map((e,n)=>({x:e,y:t[n]})),a=Math.min(...e),r=Math.max(...e);return Number.isFinite(a)&&Number.isFinite(r)?{points:n,minFrequency:a,maxFrequency:r}:null}function c(e,t){return null==e||Number.isNaN(e)?"-":Number(e).toFixed(t)}function u(e){return e&&0!==e?e>=1e3?(e/1e3).toFixed(2)+" kHz":e.toFixed(1)+" Hz":"-"}function d(e,t){const n=e.querySelector(".gll-frequency-response-loading");n&&(n.style.display="none");const a=e.querySelector(".gll-frequency-response-chart");a&&(a.innerHTML=`\n\t\t\t<div class="gll-error" style="padding: 20px; color: #d63638; border: 1px solid #d63638; border-radius: 4px; background: #fff8f8;">\n\t\t\t\t<strong>Error:</strong> ${t}\n\t\t\t</div>\n\t\t`,a.style.display="block")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.querySelectorAll(".gll-frequency-response-block");if(0!==e.length)if("undefined"!=typeof Chart){try{await(0,t.ensureWasmReady)()}catch(t){return console.error("Failed to initialize WASM:",t),void e.forEach(e=>{d(e,"Failed to initialize WASM parser")})}e.forEach(e=>{!async function(e){const t=e.dataset.fileUrl,n=e.dataset.fileName||"GLL File",a=parseInt(e.dataset.sourceIndex,10)||0,r=parseInt(e.dataset.responseIndex,10)||0,s=e.dataset.phaseMode||"unwrapped",o="true"===e.dataset.normalized,p=parseFloat(e.dataset.azimuth)||0,f=parseFloat(e.dataset.elevation)||0,h="false"!==e.dataset.showPhase,g="false"!==e.dataset.showMagnitude,y=parseInt(e.dataset.chartHeight,10)||400;if(t)try{const m=await fetch(t);if(!m.ok)throw new Error(`Failed to fetch file: ${m.statusText}`);const w=await m.arrayBuffer(),b=new Uint8Array(w),x=await i(b),v=e.querySelector(".gll-frequency-response-loading");v&&(v.style.display="none"),function(e,t,n){const a=e.querySelector(".gll-frequency-response-chart");if(!a)return;const r=t?.Database?.SourceDefinitions?.[n.sourceIndex];if(!r)return void d(e,"Source not found");const s=function(e,t,n,a,r){if(!e||!e.Responses||0===e.Responses.length)return null;const s=e.Responses[t];if(!s)return null;const o=s.Frequencies||[];if(0===o.length)return null;const i=s.TransferFunctions||[];if(0===i.length)return null;const l=i[0],c=l.Magnitude||[],u=l.Phase||[];if(0===c.length)return null;let d=c;if(r&&c.length>0){const e=c[0];d=c.map(t=>t-e)}return{frequencies:o,magnitudes:d,phases:u.length===c.length?u:[]}}(r,n.responseIndex,0,0,n.normalized);if(!s)return void d(e,"No frequency response data available for this source");const{frequencies:o,magnitudes:i,phases:p}=s,f=l(o,i);if(!f)return void d(e,"Invalid frequency response data");let h=null;if(n.showPhase&&p.length>0){const e=function(e){if(!Array.isArray(e)||0===e.length)return[];const t=[e[0]];let n=0;for(let a=1;a<e.length;a++){const r=e[a]-e[a-1];r>Math.PI?n-=2*Math.PI:r<-Math.PI&&(n+=2*Math.PI),t.push(e[a]+n)}return t}(p);h=function(e,t,n,a){switch(e){case"wrapped":return{values:n.map(e=>function(e){if(null==e)return null;const t=2*Math.PI;return((e+Math.PI)%t+t)%t-Math.PI}(e)),label:"Phase (rad)",axisTitle:"Phase (rad)",format:e=>c(e,4)};case"group-delay":{const e=function(e,t){if(!Array.isArray(e)||0===e.length)return[];const n=Math.min(e.length,t.length),a=new Array(n),r=-1/(2*Math.PI);for(let s=0;s<n;s++){let o,i;if(0===s?(o=t[s+1]-t[s],i=e[s+1]-e[s]):s===n-1?(o=t[s]-t[s-1],i=e[s]-e[s-1]):(o=t[s+1]-t[s-1],i=e[s+1]-e[s-1]),!i||0===i||Number.isNaN(i)||Number.isNaN(o)){a[s]=null;continue}const l=r*(o/i);a[s]=1e3*l}return a}(t,a);return{values:e,label:"Group Delay (ms)",axisTitle:"Group Delay (ms)",format:e=>c(e,3)}}default:return{values:a,label:"Phase (rad)",axisTitle:"Phase (rad)",format:e=>c(e,4)}}}(n.phaseMode,o,p,e)}const g=function({source:e,frequencyData:t,options:n,phaseSeries:a}){const r=u(t.minFrequency),s=u(t.maxFrequency),o=[];if(o.push(`<span class="gll-meta-badge"><strong>Range:</strong> ${r} - ${s}</span>`),0!==n.azimuth||0!==n.elevation?o.push(`<span class="gll-meta-badge"><strong>Position:</strong> Az ${n.azimuth}째 / El ${n.elevation}째</span>`):o.push('<span class="gll-meta-badge"><strong>Position:</strong> On-axis (0째 / 0째)</span>'),a){const e="group-delay"===n.phaseMode?"Group Delay":"wrapped"===n.phaseMode?"Wrapped Phase":"Unwrapped Phase";o.push(`<span class="gll-meta-badge"><strong>Phase:</strong> ${e}</span>`)}return n.normalized&&o.push('<span class="gll-meta-badge gll-meta-badge-highlight"><strong>Normalized</strong></span>'),e.Label&&o.push(`<span class="gll-meta-badge"><strong>Source:</strong> ${e.Label}</span>`),`<div class="gll-frequency-response-metadata">${o.join("")}</div>`}({source:r,frequencyData:f,options:n,phaseSeries:h}),y=document.createElement("canvas");a.innerHTML=g;const m=document.createElement("div");m.className="gll-chart-container",m.appendChild(y),a.appendChild(m),a.style.display="block";const w=y.getContext("2d"),b=[];if(n.showMagnitude&&b.push({label:"Level (dB)",data:f.points,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3,pointRadius:0,yAxisID:"y"}),h){const e=l(o,h.values);e&&b.push({label:h.label,data:e.points,borderColor:"#dc2626",backgroundColor:"transparent",tension:.3,pointRadius:0,yAxisID:"y1"})}const x={x:(v=f.minFrequency,M=f.maxFrequency,P="Frequency",{type:"logarithmic",title:{display:!0,text:P},ticks:{autoSkip:!1,callback:e=>{const t=Number(e);return function(e){if(!e||e<=0)return!1;const t=Math.log10(e);return Number.isInteger(t)}(t)?(n=t)&&0!==n?n>=1e3?(n/1e3).toFixed(1)+"k":n.toFixed(0):"-":"";var n}},min:v,max:M,afterBuildTicks:e=>{e.ticks=function(e,t){if(!e||!t||e<=0||t<=0)return[];const n=[],a=Math.max(1,Math.floor(Math.log10(e))),r=Math.ceil(Math.log10(t));for(let s=a;s<=r;s++){const a=Math.pow(10,s);for(let r=1;r<=9;r++){const s=r*a;s<e||s>t||n.push({value:s})}}return n}(e.min,e.max)}})};var v,M,P;n.showMagnitude&&(x.y={type:"linear",display:!0,position:"left",title:{display:!0,text:"Level (dB)"}}),h&&(x.y1={type:"linear",display:!0,position:"right",title:{display:!0,text:h.axisTitle},grid:{drawOnChartArea:!1}}),new Chart(w,{type:"line",data:{datasets:b},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:x,plugins:{legend:{position:"top"},title:{display:!0,text:n.fileName+(r.Label?` - ${r.Label}`:"")},tooltip:{callbacks:{title:e=>{const t=e?.[0]?.parsed?.x;return t?u(t):""}}}}}})}(e,x,{fileName:n,sourceIndex:a,responseIndex:r,phaseMode:s,normalized:o,azimuth:p,elevation:f,showPhase:h,showMagnitude:g,chartHeight:y})}catch(t){console.error("Error loading GLL file:",t),d(e,t.message)}else d(e,"No file URL specified")}(e)})}else console.error("Chart.js is not loaded")})})();