# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a WordPress Gutenberg block plugin that displays GLL (Generic Loudspeaker Library) file data. The plugin uses WebAssembly (WASM) compiled from Go to parse GLL files and React-based Gutenberg blocks to visualize acoustic data including frequency response charts, polar plots, and 3D directivity visualizations.

**GitHub Organization:** MeKo-Tech
**GitHub Username:** MeKo-Christian

## Build Commands

```bash
# Development build with watch mode
npm start

# Production build
npm run build

# Linting
npm run lint:js    # JavaScript/JSX linting
npm run lint:css   # CSS/SCSS linting

# Format code
npm run format

# Update WordPress packages
npm run packages-update

# Create distributable plugin ZIP
npm run plugin-zip
```

## Architecture

### WASM-Based Parsing

The plugin uses a hybrid approach for GLL file parsing:

- **Editor (Gutenberg):** WASM-based parsing in real-time for preview
- **Frontend:** Cached parsed metadata stored in WordPress post meta (planned)
- **WASM Assets:** Located in `assets/wasm/` directory
  - `gll.wasm` (~4MB) - Compiled Go parser
  - `wasm_exec.js` - Go WebAssembly runtime

The WASM parser is loaded on-demand and shared across all blocks through React Context.

### Plugin Structure

```
gll-info.php                   # Main plugin file, registers blocks and CPT
includes/class-gll-media.php   # Media library integration for .gll files
assets/wasm/                   # WASM binaries
src/
  shared/                      # Shared modules
    wasm-loader.js            # WASM initialization and parsing
    gll-context.js            # React Context for GLL data
    index.js                  # Shared exports
  gll-info/                   # Main block (file selector + overview)
    block.json               # Block metadata
    index.js                 # Block registration
    edit.js                  # Editor component
    save.js                  # Save component (renders data attributes)
    view.js                  # Frontend hydration script
    editor.scss              # Editor styles
    style.scss               # Frontend styles
build/                        # Compiled output (generated by wp-scripts)
```

### WordPress Integration

- **Custom Post Type:** `gll_file` for managing GLL file entries
- **MIME Type:** `.gll` files registered as `application/x-gll` in media library
- **Block Registration:** Uses WordPress 6.8's `blocks-manifest.php` for efficient registration with fallback support
- **Asset Loading:** Conditional loading based on block presence via `has_block()`

### React Context Architecture

The plugin uses React Context (`GLLContext`) to share parsed GLL data between blocks:

- **GLLProvider:** Wraps components that need GLL data
- **useGLL():** Hook for components within GLLProvider
- **useGLLLoader():** Standalone hook for components that only need parsing

All WASM operations are asynchronous and ensure initialization before parsing.

## Development Workflow

### Adding New Blocks

When creating new visualization blocks (frequency response, polar plots, 3D balloon):

1. Create a new directory under `src/` (e.g., `src/frequency-response/`)
2. Follow the same structure as `src/gll-info/`:
   - `block.json` - Block metadata
   - `index.js` - Registration
   - `edit.js` - Editor component
   - `save.js` - Save component
   - `view.js` - Frontend script
   - `editor.scss` & `style.scss` - Styles
3. Use `useGLLLoader()` hook to access parsed GLL data
4. Reference the web demo at https://meko-christian.github.io/gll-tools/ for visualization implementation

### WASM Loader Usage

```javascript
import { useGLLLoader } from '../shared';

// In component:
const { data, isLoading, error, load, clear } = useGLLLoader();

// Load from URL:
await load(fileUrl, true);

// Load from File object:
await load(fileObject, false);
```

### Block Attributes Pattern

Blocks should follow this pattern for GLL file attributes:

```json
{
  "fileId": { "type": "number", "default": 0 },
  "fileUrl": { "type": "string", "default": "" },
  "fileName": { "type": "string", "default": "" }
}
```

## Implementation Status

See [PLAN.md](PLAN.md) for the complete implementation roadmap. Current status:

- ✅ Phase 1: Foundation (WASM loader, React context, media library)
- ✅ Phase 2: Core file block (file selector with MediaUpload)
- ✅ Phase 3: Overview block (integrated into main block)
- ✅ Phase 7: Sources list (integrated into main block)
- ⏳ Phase 4: Frequency response block (Chart.js dependency added)
- ⏳ Phases 5-6, 8-11: Remaining visualization blocks

The main block (`gll-info/gll-info`) currently integrates overview and sources display with toggle controls in the InspectorControls panel.

## Key Technical Notes

### WASM Initialization

- WASM is loaded lazily on first use
- The loader is a singleton pattern to prevent multiple initializations
- Browser WASM support is required (no fallback for old browsers)

### WordPress Compatibility

- **Minimum WordPress:** 6.7
- **Minimum PHP:** 7.4
- Uses `wp-scripts` build toolchain (version ^31.3.0)
- Follows WordPress coding standards for PHP

### Dependencies

**Core:**
- `@wordpress/scripts` - Build toolchain
- `@wordpress/block-editor` - Gutenberg editor components
- `@wordpress/blocks` - Block registration
- `@wordpress/element` - React wrapper
- `@wordpress/i18n` - Internationalization

**Visualization:**
- `chart.js` (^4.4.1) - For frequency response and polar plots
- `three` (planned) - For 3D balloon visualization

### Data Structure

The parsed GLL data includes:
- `Header` - Format version, checksum
- `GenSystem` - System metadata (Label, Version, Type, Manufacturer)
- `Metadata` - Description and other metadata
- `Database` - Acoustic data including:
  - `SourceDefinitions` - Acoustic sources
  - Transfer functions for frequency response
  - Directivity data for polar/3D visualization

## Security Notes

- GLL files are binary and parsed client-side via WASM
- Media upload restrictions apply (WordPress user capabilities)
- No server-side parsing eliminates server-side attack vectors
- WASM sandboxing provides isolation

## Testing Considerations

When adding tests:
- Test WASM initialization and error handling
- Test file parsing with valid and invalid GLL files
- Test React component rendering with different data states
- Test media library integration
- Test frontend hydration script

## Reference Implementation

The existing web demo serves as the reference for all visualizations:
https://meko-christian.github.io/gll-tools/

When implementing visualization blocks, closely reference the web demo's:
- Chart configurations (frequency response, polar plots)
- Three.js scene setup (3D balloon)
- Interactive controls (sliders, dropdowns)
- Data mapping and transformation logic
